{% extends "base.html" %}
{% block title %}
    Admin Settings - {{ app_settings.app_title }}
{% endblock %}

{% block head %}
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde/dist/simplemde.min.css">
     LOCAL VERSION BELOW
    -->
     <link rel="stylesheet" href="/static/css/simplemde.min.css">

    <style>
        /* Style for the color swatch in the table */
        .color-swatch-container {
            display: flex;
            align-items: center;
        }
        .color-input-swatch {
            display: inline-block;
            width: 25px;
            height: 25px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            vertical-align: middle;
            margin-right: 8px;
        }
        /* Hide the actual color input visually but keep it functional */
        .classification-color-input {
            opacity: 0;
            width: 0;
            height: 0;
            padding: 0;
            border: none;
            position: absolute;
        }
         /* Ensure table cells have consistent vertical alignment */
        #classification-categories-tbody td {
            vertical-align: middle;
        }
    </style>
{% endblock %}

{% block content %}
<div id="index-warning-user" class="alert alert-warning" style="display:none;">
    <strong>⚠️ User-index schema mismatch:</strong>
    Missing fields: <span id="missing-fields-user"></span>
    <button id="fix-user-index-btn" class="btn btn-sm btn-primary ms-2">Add missing user-fields</button>
</div>
  
<div id="index-warning-group" class="alert alert-warning" style="display:none;">
    <strong>⚠️ Group-index schema mismatch:</strong>
    Missing fields: <span id="missing-fields-group"></span>
    <button id="fix-group-index-btn" class="btn btn-sm btn-primary ms-2">Add missing group-fields</button>
</div>
  
<!-- Flash messages display section -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="container">
    <h2>Admin Settings</h2>
    <form method="post" enctype="multipart/form-data" id="admin-settings-form">
        <p class="text-muted">Use this form to configure the administrative settings for your application.</p>
        <p class="text-muted">
            Version: {{ config['VERSION'] }}
            {% if update_available %}
                <span class="ms-2 badge bg-warning text-dark align-middle"> 
                    New version available, v{{ latest_version }}.
                    <a href="{{ download_url }}" target="_blank" rel="noopener noreferrer" class="link-primary text-decoration-underline">Download here</a>.
                </span>
            {% endif %}
        </p>
        <div class="d-flex align-items-center mb-3">
            <button type="submit" class="btn btn-primary mt-3">Save Settings</button>
            <button type="button" class="btn btn-outline-secondary mt-3 ms-2" id="launch-walkthrough-btn">
                <i class="bi bi-signpost-split"></i> Start Setup Walkthrough
            </button>
        </div>

        <!-- Settings Walkthrough Inline Container -->
        <div id="settings-walkthrough-container" class="card mb-4 shadow-sm" style="display: none;">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Setup Walkthrough</h5>
                <button type="button" class="btn-close btn-close-white" id="close-walkthrough-btn" aria-label="Close"></button>
            </div>
            <div class="card-body">
                <!-- Progress bar -->
                <div class="progress mb-4" style="height: 8px;">
                    <div id="walkthrough-progress" class="progress-bar bg-primary" role="progressbar" style="width: 8%;" aria-valuenow="1" aria-valuemin="0" aria-valuemax="12"></div>
                </div>

                <!-- Step content area -->
                <div id="walkthrough-step-content">
                    <!-- Step 1: App Title and Logo -->
                    <div id="walkthrough-step-1" class="walkthrough-step">
                        <h4>1. Configure Application Basics</h4>
                        <p class="text-muted">Let's set up your Simple Chat instance. Let's start with some basic configuration options.</p>
                        
                        <div class="alert alert-info">
                            <strong>Optional:</strong> Configure your application title and logo.
                        </div>
                        
                        <ul class="list-group mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Application Title</span>
                                <span class="badge bg-secondary">Optional</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Custom Logo</span>
                                <span class="badge bg-secondary">Optional</span>
                            </li>
                        </ul>
                        
                        <p>Use the <strong>General</strong> tab to configure these settings.</p>
                    </div>

                    <!-- Step 2: Configure GPT Settings -->
                    <div id="walkthrough-step-2" class="walkthrough-step" style="display: none;">
                        <h4>2. Configure GPT API Settings</h4>
                        <p class="text-muted">Configure the Azure OpenAI GPT API settings.</p>
                        
                        <div class="alert alert-danger">
                            <strong>Required:</strong> GPT API configuration is required for Simple Chat to function.
                        </div>
                        
                        <ul class="list-group mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>GPT Endpoint</span>
                                <span class="badge bg-danger">Required</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Authentication</span>
                                <span class="badge bg-danger">Required</span>
                            </li>
                        </ul>
                        
                        <div class="alert alert-info">
                            <strong>API Management Option:</strong> You can configure a direct connection to Azure OpenAI or use Azure API Management (APIM).
                            <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" title="APIM provides an additional layer for security, monitoring, and rate limiting. Use APIM when you need centralized API governance or want to isolate direct access to your Azure OpenAI resources."></i>
                        </div>
                        
                        <p>Configure GPT API settings in the <strong>GPT</strong> tab.</p>
                    </div>

                    <!-- Step 3: Select GPT Models -->
                    <div id="walkthrough-step-3" class="walkthrough-step" style="display: none;">
                        <h4>3. Select GPT Models</h4>
                        <p class="text-muted">Now that you've configured the GPT API settings, fetch and select the GPT models to use.</p>
                        
                        <div class="alert alert-danger">
                            <strong>Required:</strong> Select at least one GPT model for users to use.
                        </div>
                        
                        <p class="mb-4">
                            <ol>
                                <li id="fetch-models-step">Click the <strong>"Fetch GPT Models"</strong> button to retrieve available models</li>
                                <li>Select one or more models from the list</li>
                            </ol>
                        </p>
                        
                        <div class="alert alert-info" id="apim-model-note" style="display: none;">
                            <strong>APIM Configuration:</strong> When using APIM, enter model names directly in the "Azure APIM Deployment" field (e.g., "gpt-4o, gpt-35-turbo"). Fetching models is not available with APIM.
                        </div>
                        
                        <div class="alert alert-info">
                            <strong>Note:</strong> Ensure the Service Principal has been assigned the Cognitive Service OpenAI User role on the Azure OpenAI endpoint.
                        </div>
                    </div>

                    <!-- Step 4: Workspaces -->
                    <div id="walkthrough-step-4" class="walkthrough-step" style="display: none;">
                        <h4>4. Configure Workspaces</h4>
                        <p class="text-muted">Enable workspace features for your users.</p>
                        
                        <div class="alert alert-info">
                            <strong>Optional:</strong> Enable personal and group workspaces for document management.
                        </div>
                        
                        <ul class="list-group mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Your Workspace (Personal Workspace)</span>
                                <span class="badge bg-secondary">Optional</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>My Groups (Group Workspaces)</span>
                                <span class="badge bg-secondary">Optional</span>
                            </li>
                        </ul>
                        
                        <p class="alert alert-warning">
                            <strong>Important:</strong> If you enable either workspace feature, you will need to configure additional services in the next steps.
                        </p>
                    </div>

                    <!-- Step 5: Embedding Settings -->
                    <div id="walkthrough-step-5" class="walkthrough-step" style="display: none;">
                        <h4>5. Configure Embedding API Settings</h4>
                        <p class="text-muted">Configure the embedding service for document processing.</p>
                        
                        <div id="embedding-requirement-alert" class="alert alert-danger">
                            <strong>Required:</strong> Embedding API configuration is required if workspaces are enabled.
                        </div>
                        
                        <ul class="list-group mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Embedding Endpoint</span>
                                <span id="embedding-required-badge" class="badge bg-danger">Required</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Authentication</span>
                                <span id="embedding-auth-badge" class="badge bg-danger">Required</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Fetch Models</span>
                                <span id="fetch-models-badge" class="badge bg-danger">Required</span>
                            </li>
                        </ul>
                        
                        <div class="alert alert-info">
                            <strong>API Management Option:</strong> You can configure a direct connection to Azure OpenAI or use Azure API Management (APIM).
                            <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" title="APIM provides an additional layer for security, monitoring, and rate limiting. APIM requires manual model configuration as the fetch functionality is not available."></i>
                        </div>
                        
                        <div class="alert alert-info">
                            <strong>Note:</strong> Ensure the Service Principal has been assigned the Cognitive Service OpenAI User role on the Azure OpenAI endpoint.
                        </div>
                    </div>

                    <!-- Step 6: AI Search Settings -->
                    <div id="walkthrough-step-6" class="walkthrough-step" style="display: none;">
                        <h4>6. Configure Azure AI Search</h4>
                        <p class="text-muted">Configure Azure AI Search for document indexing.</p>
                        
                        <div id="ai-search-requirement-alert" class="alert alert-danger">
                            <strong>Required:</strong> Azure AI Search is required if workspaces are enabled.
                        </div>
                        
                        <ul class="list-group mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>AI Search Endpoint</span>
                                <span id="search-endpoint-badge" class="badge bg-danger">Required</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Authentication</span>
                                <span id="search-auth-badge" class="badge bg-danger">Required</span>
                            </li>
                        </ul>
                        
                        <div class="alert alert-info">
                            <strong>API Management Option:</strong> You can configure a direct connection to Azure AI Search or use Azure API Management (APIM).
                            <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" title="APIM provides an additional layer for security, monitoring, and rate limiting. Use APIM when you need centralized API governance or want to isolate direct access to your Azure resources."></i>
                        </div>
                    </div>

                    <!-- Step 7: Document Intelligence -->
                    <div id="walkthrough-step-7" class="walkthrough-step" style="display: none;">
                        <h4>7. Configure Document Intelligence</h4>
                        <p class="text-muted">Configure Azure Document Intelligence for processing documents.</p>
                        
                        <div id="doc-intelligence-requirement-alert" class="alert alert-danger">
                            <strong>Required:</strong> Document Intelligence is required if workspaces are enabled.
                        </div>
                        
                        <ul class="list-group mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Document Intelligence Endpoint</span>
                                <span id="doc-endpoint-badge" class="badge bg-danger">Required</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Authentication</span>
                                <span id="doc-auth-badge" class="badge bg-danger">Required</span>
                            </li>
                        </ul>
                        
                        <div class="alert alert-info">
                            <strong>API Management Option:</strong> You can configure a direct connection to Document Intelligence or use Azure API Management (APIM).
                            <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" title="APIM provides an additional layer for security, monitoring, and rate limiting. Use APIM when you need centralized API governance or want to isolate direct access to your Azure resources."></i>
                        </div>
                    </div>

                    <!-- Step 8: Video File Support -->
                    <div id="walkthrough-step-8" class="walkthrough-step" style="display: none;">
                        <h4>8. Enable Video File Support</h4>
                        <p class="text-muted">Configure support for video file processing.</p>
                        
                        <div id="video-support-requirement-alert" class="alert alert-danger">
                            <strong>Required:</strong> Video support configuration is required if workspaces are enabled.
                        </div>
                        
                        <p class="mb-3">Use the <strong>Video Support</strong> settings in the Workspaces tab to enable and configure video file processing.</p>
                        
                        <ul class="list-group mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Video Indexer Endpoint</span>
                                <span id="video-endpoint-badge" class="badge bg-danger">Required</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Video Indexer API Key</span>
                                <span id="video-key-badge" class="badge bg-danger">Required</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Step 9: Audio File Support -->
                    <div id="walkthrough-step-9" class="walkthrough-step" style="display: none;">
                        <h4>9. Enable Audio File Support</h4>
                        <p class="text-muted">Configure support for audio file processing.</p>
                        
                        <div id="audio-support-requirement-alert" class="alert alert-danger">
                            <strong>Required:</strong> Audio support configuration is required if workspaces are enabled.
                        </div>
                        
                        <p class="mb-3">Use the <strong>Audio Support</strong> settings in the Workspaces tab to enable and configure audio file processing.</p>
                        
                        <ul class="list-group mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Speech Service Endpoint</span>
                                <span id="audio-endpoint-badge" class="badge bg-danger">Required</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Speech Service Key</span>
                                <span id="audio-key-badge" class="badge bg-danger">Required</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Step 10: Content Safety -->
                    <div id="walkthrough-step-10" class="walkthrough-step" style="display: none;">
                        <h4>10. Content Safety Settings</h4>
                        <p class="text-muted">Configure content safety features.</p>
                        
                        <div class="alert alert-info">
                            <strong>Optional:</strong> Enable content safety features to filter inappropriate content.
                        </div>
                    </div>

                    <!-- Step 11: User Feedback and Archiving -->
                    <div id="walkthrough-step-11" class="walkthrough-step" style="display: none;">
                        <h4>11. User Feedback and Conversation Archiving</h4>
                        <p class="text-muted">Configure user feedback and conversation archiving features.</p>
                        
                        <div class="alert alert-info">
                            <strong>Optional:</strong> Enable user feedback and conversation archiving.
                        </div>
                        
                        <ul class="list-group mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>User Feedback</span>
                                <span class="badge bg-secondary">Optional</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Conversation Archiving</span>
                                <span class="badge bg-secondary">Optional</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Step 12: Enhanced Citations and Image Generation -->
                    <div id="walkthrough-step-12" class="walkthrough-step" style="display: none;">
                        <h4>12. Enhanced Citations and Image Generation</h4>
                        <p class="text-muted">Configure additional features.</p>
                        
                        <div class="alert alert-info">
                            <strong>Optional:</strong> Enable enhanced citations and image generation features.
                        </div>
                        
                        <ul class="list-group mb-4">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Enhanced Citations</span>
                                <span class="badge bg-secondary">Optional</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>Image Generation</span>
                                <span class="badge bg-secondary">Optional</span>
                            </li>
                        </ul>
                        
                        <div class="alert alert-success">
                            <strong>Congratulations!</strong> You've completed the initial setup walkthrough. You can now continue to configure your Simple Chat instance in detail.
                        </div>
                    </div>
                </div>

                <!-- Navigation buttons -->
                <div class="mt-3 d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="walkthrough-prev-btn">Previous</button>
                    <div>
                        <button type="button" class="btn btn-primary" id="walkthrough-next-btn">Next</button>
                        <button type="button" class="btn btn-success" id="walkthrough-finish-btn" style="display: none;">Finish Setup and Save</button>
                    </div>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs" id="adminSettingsTab" role="tablist">
            
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general"
                    type="button" role="tab" aria-controls="general" aria-selected="true">
                    General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gpt-tab" data-bs-toggle="tab" data-bs-target="#gpt" type="button"
                    role="tab" aria-controls="gpt" aria-selected="false">
                    GPT
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="embeddings-tab" data-bs-toggle="tab" data-bs-target="#embeddings"
                    type="button" role="tab" aria-controls="embeddings" aria-selected="false">
                    Embeddings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="image-gen-tab" data-bs-toggle="tab" data-bs-target="#image-gen"
                    type="button" role="tab" aria-controls="image-gen" aria-selected="false">
                    Image Generation
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="workspaces-tab" data-bs-toggle="tab" data-bs-target="#workspaces" type="button"
                    role="tab" aria-controls="workspaces" aria-selected="false">
                    Workspaces
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="citation-tab" data-bs-toggle="tab" data-bs-target="#citation"
                    type="button" role="tab" aria-controls="citation" aria-selected="false">
                    Citations
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="safety-tab" data-bs-toggle="tab" data-bs-target="#safety"
                    type="button" role="tab" aria-controls="safety" aria-selected="false">
                    Safety
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="search-extract-tab" data-bs-toggle="tab" data-bs-target="#search-extract"
                    type="button" role="tab" aria-controls="search-extract" aria-selected="false">
                    Search and Extract
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other" type="button"
                    role="tab" aria-controls="other" aria-selected="false">
                    Other
                </button>
            </li>
        </ul>

        
        <div class="tab-content mt-3" id="adminSettingsTabContent">

            
            <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                
                 <p class="text-muted">
                    Configure general application settings, including the application’s title, logo, and landing page text.
                </p>
                <div class="card p-3 mb-3">
                    <div class="mb-3">
                        <label for="app_title" class="form-label">Application Title</label>
                        <input type="text" class="form-control" id="app_title" name="app_title" value="{{ settings.app_title }}">
                    </div>
                    <h5 class="mt-3">Logo Settings</h5>
                    <div class="form-group form-check form-switch mb-3">
                        <input type="checkbox" class="form-check-input" id="show_logo" name="show_logo"
                            {% if settings.show_logo %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="show_logo">Show Logo</label>
                    </div>
                    <div class="form-group mb-3">
                        <label for="logo_file">Upload Custom Logo</label>
                        <input type="file" class="form-control" name="logo_file" id="logo_file" accept=".png,.jpg,.jpeg">
                    </div>
                </div>

                
                <div class="card p-3 mb-3">
                    <h5>Page Text (Markdown)</h5>
                    <p class="text-muted mb-1">You can either edit the text in a Markdown editor or switch to a preview mode.</p>

                    
                    <div class="form-check form-switch mb-3">
                        <input
                            class="form-check-input"
                            type="checkbox"
                            id="toggleLandingPageEditor"
                            name="enable_landing_page_editor"
                            {% if settings.enable_landing_page_editor %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="toggleLandingPageEditor">
                            Enable Markdown Editor
                        </label>
                    </div>

                    
                    <div id="landingPageEditorContainer" style="display: none;">
                        <textarea
                            class="form-control"
                            id="landing_page_text_editor"
                            name="landing_page_text"
                            rows="5"
                        >{{ settings.landing_page_text }}</textarea>
                    </div>

                    
                    <div
                        id="landingPageMarkdownPreview"
                        class="p-2 border rounded"
                        style="white-space: pre-wrap; display: none;"
                    ></div>
                </div>

                <!-- Dark Mode Card -->
                <div class="card p-3 mb-3">
                    <h5>Appearance</h5>
                    <p class="text-muted mb-1">Configure the app appearance and theme settings.</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Default Theme</label>
                        <div class="form-group form-check form-switch mb-3">
                            <input
                                type="checkbox"
                                class="form-check-input"
                                id="enable_dark_mode_default"
                                name="enable_dark_mode_default"
                                {% if settings.enable_dark_mode_default %}checked{% endif %}
                            >
                            <label class="form-check-label ms-2" for="enable_dark_mode_default">
                                Enable Dark Mode by Default
                            </label>
                        </div>
                        <p class="text-muted small">Users can still toggle dark mode individually from the navigation bar.</p>
                    </div>
                </div>
                <!-- New Classification Banner Section -->
                <div class="card p-3 mb-3">
                    <h5>Classification Banner</h5>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="classification_banner_enabled" name="classification_banner_enabled"
                            {% if settings.classification_banner_enabled %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="classification_banner_enabled">
                            Enable Classification Banner
                        </label>
                    </div>
                    <div class="mb-2">
                        <label for="classification_banner_text" class="form-label">Banner Text</label>
                        <input type="text" class="form-control" id="classification_banner_text" name="classification_banner_text"
                            value="{{ settings.classification_banner_text }}">
                    </div>
                    <div class="mb-2">
                        <label for="classification_banner_color" class="form-label">Banner Color</label>
                        <input type="color" class="form-control form-control-color" id="classification_banner_color" name="classification_banner_color"
                            value="{{ settings.classification_banner_color or '#ffc107' }}" style="width: 3rem; height: 2rem;">
                    </div>
                    <div class="mb-2">
                        <span id="classification-banner-preview"
                              style="display:inline-block; padding:0.5em 1em; border-radius:0.3em; font-weight:bold; color:#fff; background:{{ settings.classification_banner_color or '#ffc107' }};">
                            {{ settings.classification_banner_text or 'Banner Preview' }}
                        </span>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="gpt" role="tabpanel" aria-labelledby="gpt-tab">
                
                 <p class="text-muted">
                    Configure your GPT model settings. These are used for generating AI text responses.
                </p>

                <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                    <input type="checkbox" class="form-check-input me-2" id="enable_gpt_apim" name="enable_gpt_apim" {%
                        if settings.enable_gpt_apim %}checked{% endif %}>
                    <label class="form-check-label" for="enable_gpt_apim">Use APIM instead of direct to Azure OpenAI
                        endpoint</label>
                    <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" title="APIM provides an additional layer for security, monitoring, and rate limiting. When using APIM, you'll need to manually specify your model names and will not be able to fetch models automatically."></i>
                </div>

                <div id="non_apim_gpt_settings" {% if settings.enable_gpt_apim %}style="display: none;" {% endif %}>
                    <div class="card p-3 mb-3">
                        <div class="mb-3">
                            <label for="azure_openai_gpt_endpoint" class="form-label">
                                Azure OpenAI GPT Endpoint
                            </label>
                            <input type="text" class="form-control" id="azure_openai_gpt_endpoint"
                                name="azure_openai_gpt_endpoint" value="{{ settings.azure_openai_gpt_endpoint or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_gpt_authentication_type" class="form-label">
                                Authentication Type
                            </label>
                            <select class="form-select" id="azure_openai_gpt_authentication_type"
                                name="azure_openai_gpt_authentication_type">
                                <option value="key" {% if settings.azure_openai_gpt_authentication_type=='key'
                                    %}selected{% endif %}>
                                    Key
                                </option>
                                <option value="managed_identity" {% if
                                    settings.azure_openai_gpt_authentication_type=='managed_identity' %}selected{% endif
                                    %}>
                                    Managed Identity
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_gpt_subscription_id" class="form-label">Subscription ID</label>
                            <input type="text" class="form-control" id="azure_openai_gpt_subscription_id"
                                name="azure_openai_gpt_subscription_id"
                                value="{{ settings.azure_openai_gpt_subscription_id or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_gpt_resource_group" class="form-label">Resource Group</label>
                            <input type="text" class="form-control" id="azure_openai_gpt_resource_group"
                                name="azure_openai_gpt_resource_group"
                                value="{{ settings.azure_openai_gpt_resource_group or '' }}">
                        </div>
                        <div class="mb-3" id="gpt_key_container" {% if settings.azure_openai_gpt_authentication_type
                            !='key' %}style="display: none;" {% endif %}>
                            <label for="azure_openai_gpt_key" class="form-label">Azure OpenAI GPT Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="azure_openai_gpt_key"
                                    name="azure_openai_gpt_key" value="{{ settings.azure_openai_gpt_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary"
                                    id="toggle_gpt_key">Show</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="gpt_model" class="form-label">Azure OpenAI GPT Model Selection</label>
                            <br><small>Each selected model will be available in the Chat UI as an option for the User. You can select multiple models.</small>
                            <div id="gpt_models_list" class="mt-2 mb-3">
                                
                            </div>
                            
                            <input type="hidden" name="gpt_model_json" id="gpt_model_json" />

                            
                            <input type="hidden" id="gpt_model" value="{{ settings.gpt_model.selected[0].deploymentName if settings.gpt_model.selected else '' }}" />

                            <button type="button" class="btn btn-secondary" id="fetch_gpt_models_btn">
                                Fetch GPT Models
                            </button>
                        </div>
                        <a href="#" class="fw-bold text-decoration-none mb-2" data-bs-toggle="collapse"
                            data-bs-target="#advancedGptFields" aria-expanded="false" aria-controls="advancedGptFields">
                            Show Advanced
                        </a>
                        <div class="collapse" id="advancedGptFields">
                            <div class="card card-body mt-2">
                                <div class="mb-3">
                                    <label for="azure_openai_gpt_api_version" class="form-label">
                                        Azure OpenAI GPT API Version
                                    </label>
                                    <input type="text" class="form-control" id="azure_openai_gpt_api_version"
                                        name="azure_openai_gpt_api_version"
                                        value="{{ settings.azure_openai_gpt_api_version or '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="apim_gpt_settings" class="card p-3 mb-3" {% if not settings.enable_gpt_apim
                    %}style="display: none;" {% endif %}>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_endpoint" class="form-label">Azure APIM Endpoint</label>
                        <input type="text" class="form-control" id="azure_apim_gpt_endpoint"
                            name="azure_apim_gpt_endpoint" value="{{ settings.azure_apim_gpt_endpoint or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_api_version" class="form-label">Azure APIM API Version</label>
                        <input type="text" class="form-control" id="azure_apim_gpt_api_version"
                            name="azure_apim_gpt_api_version" value="{{ settings.azure_apim_gpt_api_version or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_deployment" class="form-label">Azure APIM Deployment</label>
                        <br><small class="text-muted">Each model defined here will be available in the Chat UI as an option for the User. You can include multiple models seperated by a comma (example: gpt-4o, o-1, o-3).</small>
                        <input type="text" class="form-control" id="azure_apim_gpt_deployment"
                            name="azure_apim_gpt_deployment" value="{{ settings.azure_apim_gpt_deployment or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_gpt_subscription_key" class="form-label">Azure APIM Subscription
                            Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="azure_apim_gpt_subscription_key"
                                name="azure_apim_gpt_subscription_key"
                                value="{{ settings.azure_apim_gpt_subscription_key or '' }}">
                            <button type="button" class="btn btn-outline-secondary"
                                id="toggle_azure_apim_gpt_subscription_key">Show</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-secondary" id="test_gpt_button">
                    Test GPT Connection
                </button>
                <div id="test_gpt_result" class="mt-2"></div>
            </div>

            
            <div class="tab-pane fade" id="embeddings" role="tabpanel" aria-labelledby="embeddings-tab">
                
                 <p class="text-muted">
                    Configure your embeddings settings. These are used for semantic search, knowledge-base lookups, etc.
                </p>

                <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                    <input type="checkbox" class="form-check-input me-2" id="enable_embedding_apim"
                        name="enable_embedding_apim" {% if settings.enable_embedding_apim %}checked{% endif %}>
                    <label class="form-check-label" for="enable_embedding_apim">Use APIM instead of direct to Azure
                        OpenAI endpoint</label>
                    <i class="bi bi-info-circle ms-2" data-bs-toggle="tooltip" title="APIM provides an additional layer for security, monitoring, and rate limiting. When using APIM, you'll need to manually specify your model names and will not be able to fetch models automatically."></i>
                </div>

                <div id="non_apim_embedding_settings" {% if settings.enable_embedding_apim %}style="display: none;" {%
                    endif %}>
                    <div class="card p-3 mb-3">
                        <div class="mb-3">
                            <label for="azure_openai_embedding_endpoint" class="form-label">
                                Azure OpenAI Embedding Endpoint
                            </label>
                            <input type="text" class="form-control" id="azure_openai_embedding_endpoint"
                                name="azure_openai_embedding_endpoint"
                                value="{{ settings.azure_openai_embedding_endpoint or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_embedding_authentication_type" class="form-label">
                                Authentication Type
                            </label>
                            <select class="form-select" id="azure_openai_embedding_authentication_type"
                                name="azure_openai_embedding_authentication_type">
                                <option value="key" {% if settings.azure_openai_embedding_authentication_type=='key'
                                    %}selected{% endif %}>
                                    Key
                                </option>
                                <option value="managed_identity" {% if
                                    settings.azure_openai_embedding_authentication_type=='managed_identity' %}selected{% endif %}>
                                    Managed Identity
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_embedding_subscription_id" class="form-label">Subscription
                                ID</label>
                            <input type="text" class="form-control" id="azure_openai_embedding_subscription_id"
                                name="azure_openai_embedding_subscription_id"
                                value="{{ settings.azure_openai_embedding_subscription_id or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_openai_embedding_resource_group" class="form-label">Resource Group</label>
                            <input type="text" class="form-control" id="azure_openai_embedding_resource_group"
                                name="azure_openai_embedding_resource_group"
                                value="{{ settings.azure_openai_embedding_resource_group or '' }}">
                        </div>
                        <div class="mb-3" id="embedding_key_container" {% if
                            settings.azure_openai_embedding_authentication_type !='key' %}style="display: none;" {%
                            endif %}>
                            <label for="azure_openai_embedding_key" class="form-label">Azure OpenAI Embedding
                                Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="azure_openai_embedding_key"
                                    name="azure_openai_embedding_key"
                                    value="{{ settings.azure_openai_embedding_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary"
                                    id="toggle_embedding_key">Show</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div id="embedding_models_list" class="mt-2 mb-3">
                                
                            </div>
                            
                            <input type="hidden" name="embedding_model_json" id="embedding_model_json" />

                            
                            <input type="hidden" id="embedding_model" value="{{ settings.embedding_model.selected[0].deploymentName if settings.embedding_model.selected else '' }}" />

                            
                            <button type="button" class="btn btn-secondary" id="fetch_embedding_models_btn">
                                Fetch Embedding Models
                            </button>
                        </div>
                        <a href="#" class="fw-bold text-decoration-none mb-2" data-bs-toggle="collapse"
                            data-bs-target="#advancedEmbeddingsFields" aria-expanded="false"
                            aria-controls="advancedEmbeddingsFields">
                            Show Advanced
                        </a>
                        <div class="collapse" id="advancedEmbeddingsFields">
                            <div class="card card-body mt-2">
                                <div class="mb-3">
                                    <label for="azure_openai_embedding_api_version" class="form-label">
                                        Azure OpenAI Embedding API Version
                                    </label>
                                    <input type="text" class="form-control" id="azure_openai_embedding_api_version"
                                        name="azure_openai_embedding_api_version"
                                        value="{{ settings.azure_openai_embedding_api_version or '' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="apim_embedding_settings" class="card p-3 mb-3" {% if not settings.enable_embedding_apim
                    %}style="display: none;" {% endif %}>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_endpoint" class="form-label">Azure APIM Endpoint</label>
                        <input type="text" class="form-control" id="azure_apim_embedding_endpoint"
                            name="azure_apim_embedding_endpoint"
                            value="{{ settings.azure_apim_embedding_endpoint or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_api_version" class="form-label">Azure APIM API Version</label>
                        <input type="text" class="form-control" id="azure_apim_embedding_api_version"
                            name="azure_apim_embedding_api_version"
                            value="{{ settings.azure_apim_embedding_api_version or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_deployment" class="form-label">Azure APIM Deployment</label>
                        <input type="text" class="form-control" id="azure_apim_embedding_deployment"
                            name="azure_apim_embedding_deployment"
                            value="{{ settings.azure_apim_embedding_deployment or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="azure_apim_embedding_subscription_key" class="form-label">Azure APIM Subscription
                            Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="azure_apim_embedding_subscription_key"
                                name="azure_apim_embedding_subscription_key"
                                value="{{ settings.azure_apim_embedding_subscription_key or '' }}">
                            <button type="button" class="btn btn-outline-secondary"
                                id="toggle_azure_apim_embedding_subscription_key">Show</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-secondary" id="test_embedding_button">
                    Test Embeddings Connection
                </button>
                <div id="test_embedding_result" class="mt-2"></div>
            </div>

            
            <div class="tab-pane fade" id="image-gen" role="tabpanel" aria-labelledby="image-gen-tab">
                
                 <p class="text-muted">
                    Configure image generation settings. Enable/disable, set endpoints, and choose a model.
                </p>

                <div class="form-group form-check form-switch mb-3">
                    <input type="checkbox" class="form-check-input" id="enable_image_generation"
                        name="enable_image_generation" {% if settings.enable_image_generation %}checked{% endif %}>
                    <label class="form-check-label ms-2" for="enable_image_generation">
                        Enable Image Generation
                    </label>
                </div>
                <div id="image_gen_settings" {% if not settings.enable_image_generation %}style="display: none;" {%
                    endif %}>

                    <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-2" id="enable_image_gen_apim"
                            name="enable_image_gen_apim" {% if settings.enable_image_gen_apim %}checked{% endif %}>
                        <label class="form-check-label" for="enable_image_gen_apim">Use APIM instead of direct to Azure
                            OpenAI endpoint.</label>
                    </div>

                    <div id="non_apim_image_gen_settings" {% if settings.enable_image_gen_apim %}style="display: none;"
                        {% endif %}>
                        <div class="card p-3 mb-3">
                            <div class="mb-3">
                                <label for="azure_openai_image_gen_endpoint" class="form-label">
                                    Azure OpenAI Image Generation Endpoint
                                </label>
                                <input type="text" class="form-control" id="azure_openai_image_gen_endpoint"
                                    name="azure_openai_image_gen_endpoint"
                                    value="{{ settings.azure_openai_image_gen_endpoint or '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="azure_openai_image_gen_authentication_type" class="form-label">
                                    Authentication Type
                                </label>
                                <select class="form-select" id="azure_openai_image_gen_authentication_type"
                                    name="azure_openai_image_gen_authentication_type">
                                    <option value="key" {% if settings.azure_openai_image_gen_authentication_type=='key'
                                        %}selected{% endif %}>
                                        Key
                                    </option>
                                    <option value="managed_identity" {% if
                                        settings.azure_openai_image_gen_authentication_type=='managed_identity'
                                        %}selected{% endif %}>
                                        Managed Identity
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="azure_openai_image_gen_subscription_id" class="form-label">Subscription
                                    ID</label>
                                <input type="text" class="form-control" id="azure_openai_image_gen_subscription_id"
                                    name="azure_openai_image_gen_subscription_id"
                                    value="{{ settings.azure_openai_image_gen_subscription_id or '' }}">
                            </div>
                            <div class="mb-3">
                                <label for="azure_openai_image_gen_resource_group" class="form-label">Resource
                                    Group</label>
                                <input type="text" class="form-control" id="azure_openai_image_gen_resource_group"
                                    name="azure_openai_image_gen_resource_group"
                                    value="{{ settings.azure_openai_image_gen_resource_group or '' }}">
                            </div>
                            <div class="mb-3" id="image_gen_key_container" {% if
                                settings.azure_openai_image_gen_authentication_type !='key' %}style="display: none;" {%
                                endif %}>
                                <label for="azure_openai_image_gen_key" class="form-label">Azure OpenAI Image Generation
                                    Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="azure_openai_image_gen_key"
                                        name="azure_openai_image_gen_key"
                                        value="{{ settings.azure_openai_image_gen_key or '' }}">
                                    <button type="button" class="btn btn-outline-secondary"
                                        id="toggle_image_gen_key">Show</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div id="image_models_list" class="mt-2 mb-3">
                                    
                                </div>
                                
                                <input type="hidden" name="image_gen_model_json" id="image_gen_model_json" />

                                
                                <input type="hidden" id="image_gen_model" value="{{ settings.image_gen_model.selected[0].deploymentName if settings.image_gen_model.selected else '' }}" />

                                
                                <button type="button" class="btn btn-secondary" id="fetch_image_models_btn">
                                    Fetch Image Generation Models
                                </button>
                            </div>
                            <a href="#" class="fw-bold text-decoration-none mb-2" data-bs-toggle="collapse"
                                data-bs-target="#advancedImageGenFields" aria-expanded="false"
                                aria-controls="advancedImageGenFields">
                                Show Advanced
                            </a>
                            <div class="collapse" id="advancedImageGenFields">
                                <div class="card card-body mt-2">
                                    <div class="mb-3">
                                        <label for="azure_openai_image_gen_api_version" class="form-label">
                                            Azure OpenAI Image Gen API Version
                                        </label>
                                        <input type="text" class="form-control" id="azure_openai_image_gen_api_version"
                                            name="azure_openai_image_gen_api_version"
                                            value="{{ settings.azure_openai_image_gen_api_version or '' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="apim_image_gen_settings" class="card p-3 mb-3" {% if not settings.enable_image_gen_apim
                        %}style="display: none;" {% endif %}>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_endpoint" class="form-label">Azure APIM Endpoint</label>
                            <input type="text" class="form-control" id="azure_apim_image_gen_endpoint"
                                name="azure_apim_image_gen_endpoint"
                                value="{{ settings.azure_apim_image_gen_endpoint or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_api_version" class="form-label">Azure APIM API
                                Version</label>
                            <input type="text" class="form-control" id="azure_apim_image_gen_api_version"
                                name="azure_apim_image_gen_api_version"
                                value="{{ settings.azure_apim_image_gen_api_version or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_deployment" class="form-label">Azure APIM
                                Deployment</label>
                            <input type="text" class="form-control" id="azure_apim_image_gen_deployment"
                                name="azure_apim_image_gen_deployment"
                                value="{{ settings.azure_apim_image_gen_deployment or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="azure_apim_image_gen_subscription_key" class="form-label">Azure APIM
                                Subscription Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="azure_apim_image_gen_subscription_key"
                                    name="azure_apim_image_gen_subscription_key"
                                    value="{{ settings.azure_apim_image_gen_subscription_key or '' }}">
                                <button type="button" class="btn btn-outline-secondary"
                                    id="toggle_azure_apim_image_gen_subscription_key">Show</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-secondary mt-3" id="test_image_button">
                    Test Image Connection
                </button>
                <div id="test_image_result" class="mt-2"></div>
            </div>

            
            <div class="tab-pane fade" id="workspaces" role="tabpanel" aria-labelledby="workspaces-tab">
                <p class="text-muted">
                    Configure workspace settings like personal/group access, multimedia support, metadata, and document classification.
                </p>

                
                <div class="card mb-3 p-3">
                    
                    <h5>Enable Your Workspace</h5>
                    <p class="text-muted">
                        Turn this on to allow access and management of your personal workspace.
                    </p>
                    <div class="form-group form-check form-switch mb-3">
                        <input type="checkbox"
                            class="form-check-input"
                            id="enable_user_workspace"
                            name="enable_user_workspace"
                            {% if settings.enable_user_workspace %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="enable_user_workspace">
                            Enable Your Workspace
                        </label>
                    </div>
                </div>

               
               <div class="card mb-3 p-3">
                    
                    <h5>Enable My Groups (includes Group Workspaces)</h5>
                    <p class="text-muted">
                        Turn this on to allow access and management of group workspaces, as well as group collaboration features.
                    </p>
                    <div class="form-group form-check form-switch mb-3">
                        <input type="checkbox"
                            class="form-check-input"
                            id="enable_group_workspaces"
                            name="enable_group_workspaces"
                            {% if settings.enable_group_workspaces %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="enable_group_workspaces">
                            Enable My Groups (includes Group Workspaces)
                        </label>
                    </div>

                    
                    <div id="create_group_permission_setting" {% if not settings.enable_group_workspaces %}style="display: none;"{% endif %}>
                        <hr> 
                        <div class="form-group form-check form-switch mb-2">
                            <input type="checkbox"
                                class="form-check-input"
                                id="require_member_of_create_group"
                                name="require_member_of_create_group"
                                {% if settings.require_member_of_create_group %}checked{% endif %}>
                            <label class="form-check-label ms-2" for="require_member_of_create_group">
                                Require Membership to Create Groups
                            </label>
                        </div>
                        <p class="text-muted small mb-0">
                            If enabled, only users who are members of the 'CreateGroups' role (defined in your App registration) can create new groups. If disabled, any authenticated user can create groups (provided 'Enable My Groups' is active).
                        </p>
                    </div>
                    
                </div>

                <div class="card mb-3 p-3">
                    
                     <h5>Multimedia Support</h5>
                    <p class="text-muted mb-2">
                        Support video and audio file upload for transcription, indexing, and embedding.
                    </p>

                    
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_video_file_support"
                            name="enable_video_file_support"
                            {% if settings.enable_video_file_support %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_video_file_support">
                            Enable Video File Support
                        </label>
                    </div>

                    <div id="video_indexer_settings" class="card mb-3 p-3"
                            {% if not settings.enable_video_file_support %}style="display: none;"{% endif %}>
                        <h5>Video Indexer Settings</h5>
                        <p class="text-muted">Configure Azure Video Indexer for transcription & indexing.</p>

                        <div class="mb-3">
                            <label for="video_indexer_endpoint" class="form-label">Endpoint</label>
                            <input type="text" readonly class="form-control"
                                id="video_indexer_endpoint" name="video_indexer_endpoint"
                                value="{{ settings.video_indexer_endpoint or 'https://api.videoindexer.ai' }}">
                        </div>

                        <div class="mb-3">
                            <label for="video_indexer_arm_api_version" class="form-label">ARM API Version</label>
                            <input type="text" readonly class="form-control"
                                id="video_indexer_arm_api_version" name="video_indexer_arm_api_version"
                                value="{{ settings.video_indexer_arm_api_version or '2021-11-10-preview' }}">
                        </div>

                        <div class="mb-3">
                            <label for="video_indexer_location" class="form-label">Location</label>
                            <input type="text" class="form-control"
                                id="video_indexer_location" name="video_indexer_location"
                                value="{{ settings.video_indexer_location or '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="video_indexer_account_id" class="form-label">Account ID</label>
                            <input type="text" class="form-control"
                                id="video_indexer_account_id" name="video_indexer_account_id"
                                value="{{ settings.video_indexer_account_id or '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="video_indexer_api_key" class="form-label">API Key</label>
                            <div class="input-group">
                            <input type="password" class="form-control"
                                    id="video_indexer_api_key" name="video_indexer_api_key"
                                    value="{{ settings.video_indexer_api_key or '' }}">
                            <button type="button" class="btn btn-outline-secondary"
                                    id="toggle_video_indexer_api_key">Show</button>
                        </div>
                        </div>

                        <div class="mb-3">
                            <label for="video_indexer_resource_group" class="form-label">Resource Group</label>
                            <input type="text" class="form-control"
                                id="video_indexer_resource_group" name="video_indexer_resource_group"
                                value="{{ settings.video_indexer_resource_group or '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="video_indexer_subscription_id" class="form-label">Subscription ID</label>
                            <input type="text" class="form-control"
                                id="video_indexer_subscription_id" name="video_indexer_subscription_id"
                                value="{{ settings.video_indexer_subscription_id or '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="video_indexer_account_name" class="form-label">Account Name</label>
                            <input type="text" class="form-control"
                                id="video_indexer_account_name" name="video_indexer_account_name"
                                value="{{ settings.video_indexer_account_name or '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="video_index_timeout" class="form-label">Timeout (seconds)</label>
                            <input type="number" class="form-control"
                                id="video_index_timeout" name="video_index_timeout"
                                value="{{ settings.video_index_timeout or 600 }}">
                        </div>
                    </div>

                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_audio_file_support"
                            name="enable_audio_file_support"
                            {% if settings.enable_audio_file_support %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_audio_file_support">
                            Enable Audio File Support
                        </label>
                    </div>

                    <div id="audio_service_settings" class="card mb-3 p-3"
                            {% if not settings.enable_audio_file_support %}style="display: none;"{% endif %}>
                        <h5>Speech Service Settings</h5>
                        <p class="text-muted">Configure Azure Speech Service for audio transcription & embedding.</p>

                        <div class="mb-3">
                            <label for="speech_service_endpoint" class="form-label">Endpoint</label>
                            <input type="text" class="form-control"
                                id="speech_service_endpoint" name="speech_service_endpoint"
                                value="{{ settings.speech_service_endpoint or '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="speech_service_location" class="form-label">Location</label>
                            <input type="text" class="form-control"
                                id="speech_service_location" name="speech_service_location"
                                value="{{ settings.speech_service_location or '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="speech_service_locale" class="form-label">Locale</label>
                            <input type="text" class="form-control"
                                id="speech_service_locale" name="speech_service_locale"
                                value="{{ settings.speech_service_locale or '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="speech_service_key" class="form-label">API Key</label>
                            <div class="input-group">
                            <input type="password" class="form-control"
                                    id="speech_service_key" name="speech_service_key"
                                    value="{{ settings.speech_service_key or '' }}">
                            <button type="button" class="btn btn-outline-secondary"
                                    id="toggle_speech_service_key">Show</button>
                            </div>
                        </div>
                    </div>


                    <p class="mt-2 mb-0">
                        <small class="text-muted">
                            <a href="#citation" onclick="switchTab(event, 'citation-tab')">
                                Enhanced Citations
                            </a>
                             will dramatically improve the citation experience for video and audio files.
                        </small>
                    </p>
                </div>

                <div class="card mb-3 p-3">
                    <h5>Metadata Extraction</h5>
                    <p class="text-muted">
                      Enable this to automatically parse and store file metadata for advanced indexing and search.
                    </p>
                    <div class="form-check form-switch mb-3">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="enable_extract_meta_data"
                        name="enable_extract_meta_data"
                        {% if settings.enable_extract_meta_data %}checked{% endif %}>
                      <label class="form-check-label ms-2" for="enable_extract_meta_data">
                        Enable Extract Meta Data
                      </label>
                    </div>
                  
                    <div id="metadata_extraction_model_settings" class="mb-3"
                         {% if not settings.enable_extract_meta_data %}style="display: none;"{% endif %}>
                      <label for="metadata_extraction_model" class="form-label">Extraction Model</label>
                      <select class="form-select" id="metadata_extraction_model" name="metadata_extraction_model"
                              data-prev="{{ settings.metadata_extraction_model or '' }}">
                        {% if settings.enable_gpt_apim %}
                          {% for d in (settings.azure_apim_gpt_deployment or '').split(',') if d %}
                            <option value="{{ d }}"
                              {% if settings.metadata_extraction_model == d %}selected{% endif %}>
                              {{ d }}
                            </option>
                          {% endfor %}
                        {% else %}
                          {% for m in settings.gpt_model.selected %}
                            <option value="{{ m.deploymentName }}"
                              {% if settings.metadata_extraction_model == m.deploymentName %}selected{% endif %}>
                              {{ m.deploymentName }} ({{ m.modelName }})
                            </option>
                          {% endfor %}
                        {% endif %}
                      </select>
                    </div>
                </div>
                  

                
                <div class="card mb-3 p-3">
                    <h5>Document Classification</h5>
                    <p class="text-muted">
                        Enable this feature to allow users to classify documents uploaded to their workspaces using predefined categories.
                    </p>
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_document_classification"
                            name="enable_document_classification"
                            {% if settings.enable_document_classification %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="enable_document_classification">
                            Enable Document Classification
                        </label>
                    </div>

                    
                    <div id="document_classification_settings" {% if not settings.enable_document_classification %}style="display: none;"{% endif %}>
                        <h6>Classification Categories</h6>
                        <p class="text-muted small">Define the labels and corresponding colors for document classification.</p>
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50%;">Label</th>
                                    <th style="width: 30%;">Color</th>
                                    <th style="width: 20%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="classification-categories-tbody">
                                
                            </tbody>
                        </table>
                        <button type="button" id="add-classification-btn" class="btn btn-success btn-sm mt-2">
                            <i class="bi bi-plus-circle"></i> Add New Category
                        </button>
                        
                        <input type="hidden" name="document_classification_categories_json" id="document_classification_categories_json">
                    </div>
                </div>
                

            </div>

            
            <div class="tab-pane fade" id="citation" role="tabpanel" aria-labelledby="citation-tab">
                
                 <p class="text-muted">
                    Configure standard and enhanced citations features for your and group workspaces.
                </p>

                
                <div class="card p-3 mb-3">
                    <h5>Standard Citations</h5>
                    <p class="text-muted">
                        Standard citations is always enabled for both Your Workspace and Group Workspace.
                    </p>
                    <p class="mb-0">
                        Users can see text content of the source/citation for documents.
                    </p>
                </div>

                
                <div class="card p-3">
                    <h5>Enhanced Citations</h5>
                    <p class="text-muted mb-2">
                        Enable Enhanced Citation to store files in a Storage Account,
                        and show direct references (Preview feature, files are saved to storage, presentation 
                        layer will be available in a future release).
                    </p>

                    
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_enhanced_citations"
                            name="enable_enhanced_citations"
                            {% if settings.enable_enhanced_citations %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_enhanced_citations">
                            Enable Enhanced Citations
                        </label>
                    </div>

                    
                    <div id="enhanced_citation_settings" style="display: none;">
                        
                        <div class="card mb-3 p-3">
                            <h6><strong>All filetypes</strong></h6>
                            <div class="mb-3">
                                <label for="office_docs_storage_account_url" class="form-label">
                                    Storage Account Connection String
                                </label>
                                
                                <div class="input-group">
                                    <input
                                        type="password" 
                                        class="form-control"
                                        id="office_docs_storage_account_url"
                                        name="office_docs_storage_account_url"
                                        value="{{ settings.office_docs_storage_account_url or '' }}"
                                    >
                                    <button type="button" class="btn btn-outline-secondary" id="toggle_office_conn_str">Show</button>
                                </div>
                                
                            </div>
                        </div>

                        
                        <!-- <div class="card mb-3 p-3">
                            <h6><strong>Video Files</strong></h6>
                            {% if settings.enable_video_file_support %}
                                
                                <div class="mb-3">
                                    <label for="video_files_storage_account_url" class="form-label">
                                        Storage Account Connection String
                                    </label>
                                    
                                    <div class="input-group">
                                        <input
                                            type="password" 
                                            class="form-control"
                                            id="video_files_storage_account_url"
                                            name="video_files_storage_account_url"
                                            value="{{ settings.video_files_storage_account_url or '' }}"
                                        >
                                        <button type="button" class="btn btn-outline-secondary" id="toggle_video_conn_str">Show</button>
                                    </div>
                                    
                                </div>
                            {% else %}
                                
                                <p class="text-danger mb-1">
                                    Video support is currently disabled in the Workspaces tab.
                                </p>
                                <p class="mt-2 mb-0">
                                    <small class="text-muted">
                                        Reference:
                                        <a href="#workspaces" onclick="switchTab(event, 'workspaces-tab')">
                                            Enable Video File Support
                                        </a>
                                        (see the Workspaces tab)
                                    </small>
                                </p>
                            {% endif %}
                        </div>

                        
                        <div class="card mb-3 p-3">
                            <h6><strong>Audio Files</strong></h6>
                            {% if settings.enable_audio_file_support %}
                                
                                <div class="mb-3">
                                    <label for="audio_files_storage_account_url" class="form-label">
                                        Storage Account Connection String
                                    </label>
                                    
                                    <div class="input-group">
                                        <input
                                            type="password" 
                                            class="form-control"
                                            id="audio_files_storage_account_url"
                                            name="audio_files_storage_account_url"
                                            value="{{ settings.audio_files_storage_account_url or '' }}"
                                        >
                                        <button type="button" class="btn btn-outline-secondary" id="toggle_audio_conn_str">Show</button>
                                    </div>
                                    
                                </div>
                            {% else %}
                                
                                <p class="text-danger mb-1">
                                    Audio support is currently disabled in the Workspaces tab.
                                </p>
                                <p class="mt-2 mb-0">
                                    <small class="text-muted">
                                        Reference:
                                        <a href="#workspaces" onclick="switchTab(event, 'workspaces-tab')">
                                            Enable Audio File Support
                                        </a>
                                        (see the Workspaces tab)
                                    </small>
                                </p>
                            {% endif %}
                        </div> -->
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="safety" role="tabpanel" aria-labelledby="safety-tab">
                
                 <p class="text-muted">
                    Configure content safety, archiving, and user feedback settings. If Content Safety is enabled, user
                    messages will be sent to the safety endpoint for analysis. If User Feedback is enabled, users will see
                    thumbs up/down to provide feedback on AI responses.
                </p>
                <div class="card p-3 mb-3">
                    
                    <h5>Content Safety</h5>
                    <p class="text-muted">Enable content safety to filter out inappropriate content.</p>
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_content_safety"
                            name="enable_content_safety"
                            {% if settings.enable_content_safety %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_content_safety">
                            Enable Content Safety
                        </label>
                    </div>

                    
                    <div id="content_safety_settings"
                         {% if not settings.enable_content_safety %}style="display: none;"{% endif %}>

                        
                        <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                            <input
                                type="checkbox"
                                class="form-check-input me-2"
                                id="enable_content_safety_apim"
                                name="enable_content_safety_apim"
                                {% if settings.enable_content_safety_apim %}checked{% endif %}
                            >
                            <label class="form-check-label" for="enable_content_safety_apim">
                                Use APIM instead of direct Content Safety endpoint
                            </label>
                        </div>

                        
                        <div id="non_apim_content_safety_settings"
                             {% if settings.enable_content_safety_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="content_safety_endpoint" class="form-label">
                                    Content Safety Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="content_safety_endpoint"
                                    name="content_safety_endpoint"
                                    value="{{ settings.content_safety_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="content_safety_authentication_type" class="form-label">
                                    Authentication Type
                                </label>
                                <select class="form-select" id="content_safety_authentication_type" name="content_safety_authentication_type">
                                    <option value="key" {% if settings.content_safety_authentication_type=='key' %}selected{% endif %}>
                                        Key
                                    </option>
                                    <option value="managed_identity" {% if settings.content_safety_authentication_type=='managed_identity' %}selected{% endif %}>
                                        Managed Identity
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3" id="content_safety_key_container" {% if settings.content_safety_authentication_type !='key' %}style="display: none;"{% endif %}>
                                <label for="content_safety_key" class="form-label">
                                    Content Safety Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="content_safety_key"
                                        name="content_safety_key"
                                        value="{{ settings.content_safety_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_content_safety_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        
                        <div id="apim_content_safety_settings"
                             {% if not settings.enable_content_safety_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_apim_content_safety_endpoint" class="form-label">
                                    Azure APIM Content Safety Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_apim_content_safety_endpoint"
                                    name="azure_apim_content_safety_endpoint"
                                    value="{{ settings.azure_apim_content_safety_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_apim_content_safety_subscription_key" class="form-label">
                                    Azure APIM Content Safety Subscription Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_apim_content_safety_subscription_key"
                                        name="azure_apim_content_safety_subscription_key"
                                        value="{{ settings.azure_apim_content_safety_subscription_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_azure_apim_content_safety_subscription_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-secondary mt-3" id="test_safety_button">
                            Test Safety Connection
                        </button>
                        <div id="test_safety_result" class="mt-2"></div>
                    </div>
                </div>

                
                <div class="card p-3 mb-3">
                    <h5>User Feedback</h5>
                    <p class="text-muted">Enable user feedback (thumbs up/down) for AI responses.</p>
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_user_feedback"
                            name="enable_user_feedback"
                            {% if settings.enable_user_feedback %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_user_feedback">
                            Enable User Feedback (Thumbs Up/Down)
                        </label>
                    </div>
                </div>
                
                
                <div class="card p-3 mb-3">
                    <h5>Admin Access Permissions</h5>
                    <p class="text-muted">Control which users can access specific administrative views related to safety and feedback.</p>

                    
                    <div class="form-group form-check form-switch mb-2">
                        <input type="checkbox"
                            class="form-check-input"
                            id="require_member_of_safety_violation_admin"
                            name="require_member_of_safety_violation_admin"
                            {% if settings.require_member_of_safety_violation_admin %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="require_member_of_safety_violation_admin">
                            Require Membership for Safety Violation Admin View
                        </label>
                    </div>
                     <p class="text-muted small mb-3">
                        If enabled, only users who are members of the 'SafetyViolationAdmin' role (defined in your App registration) can access the Safety Violations admin page. If disabled, any user with the general 'Admin' role can access it.
                    </p>

                    
                    <div class="form-group form-check form-switch mb-2">
                        <input type="checkbox"
                            class="form-check-input"
                            id="require_member_of_feedback_admin"
                            name="require_member_of_feedback_admin"
                            {% if settings.require_member_of_feedback_admin %}checked{% endif %}>
                        <label class="form-check-label ms-2" for="require_member_of_feedback_admin">
                            Require Membership for Feedback Admin View
                        </label>
                    </div>
                     <p class="text-muted small mb-0">
                        If enabled, only users who are members of the 'FeedbackAdmin' role (defined in your App registration) can access the User Feedback admin page. If disabled, any user with the general 'Admin' role can access it. Requires 'Enable User Feedback' to be active.
                    </p>
                </div>
                
                
                
                <div class="card p-3 mb-3">
                    <h5>Conversation Archiving</h5>
                    <p class="text-muted">When enabled, conversation deletions will be archived instead of permanently deleted.</p>
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_conversation_archiving"
                            name="enable_conversation_archiving"
                            {% if settings.enable_conversation_archiving %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_conversation_archiving">
                            Enable Conversation Archiving
                        </label>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="search-extract" role="tabpanel" aria-labelledby="search-extract-tab">
                
                 <p class="text-muted">
                    Configure Bing Web Search, Azure AI Search, and Document Intelligence settings.
                </p>

                
                <div class="card p-3 mb-3">
                    <h5>Bing Web Search</h5>
                    <p class="text-muted">
                        Enable Bing Web Search to allow users to search the web for information.
                    </p>
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_web_search"
                            name="enable_web_search"
                            {% if settings.enable_web_search %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_web_search">
                            Enable Bing Web Search
                        </label>
                    </div>

                    
                    <div id="web_search_settings" {% if not settings.enable_web_search %}style="display: none;"{% endif %}>

                        
                        <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                            <input
                                type="checkbox"
                                class="form-check-input me-2"
                                id="enable_web_search_apim"
                                name="enable_web_search_apim"
                                {% if settings.enable_web_search_apim %}checked{% endif %}
                            >
                            <label class="form-check-label" for="enable_web_search_apim">
                                Use APIM instead of direct Bing Web Search
                            </label>
                        </div>

                        
                        <div id="non_apim_web_search_settings" {% if settings.enable_web_search_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="bing_search_key" class="form-label">Bing Search Key</label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="bing_search_key"
                                        name="bing_search_key"
                                        value="{{ settings.bing_search_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_bing_search_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        
                        <div id="apim_web_search_settings" {% if not settings.enable_web_search_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_apim_web_search_endpoint" class="form-label">
                                    Azure APIM Web Search Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_apim_web_search_endpoint"
                                    name="azure_apim_web_search_endpoint"
                                    value="{{ settings.azure_apim_web_search_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_apim_web_search_subscription_key" class="form-label">
                                    Azure APIM Web Search Subscription Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_apim_web_search_subscription_key"
                                        name="azure_apim_web_search_subscription_key"
                                        value="{{ settings.azure_apim_web_search_subscription_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_azure_apim_web_search_subscription_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-secondary mt-3" id="test_web_search_button">
                            Test Web Search Connection
                        </button>
                        <div id="test_web_search_result" class="mt-2"></div>
                    </div>
                </div>

                
                <div class="card p-3 mb-3">
                    <h5>Azure AI Search</h5>
                    <p class="text-muted">
                        Configure Azure AI Search settings.
                    </p>
                    <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                        <input
                            type="checkbox"
                            class="form-check-input me-2"
                            id="enable_ai_search_apim"
                            name="enable_ai_search_apim"
                            {% if settings.enable_ai_search_apim %}checked{% endif %}
                        >
                        <label class="form-check-label" for="enable_ai_search_apim">
                            Use APIM instead of direct Azure AI Search
                        </label>
                    </div>

                    <div>
                        
                        <div id="non_apim_ai_search_settings" {% if settings.enable_ai_search_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_ai_search_endpoint" class="form-label">Search Endpoint</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_ai_search_endpoint"
                                    name="azure_ai_search_endpoint"
                                    value="{{ settings.azure_ai_search_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_ai_search_authentication_type" class="form-label">
                                    Authentication Type
                                </label>
                                <select class="form-select" id="azure_ai_search_authentication_type" name="azure_ai_search_authentication_type">
                                    <option value="key" {% if settings.azure_ai_search_authentication_type=='key' %}selected{% endif %}>
                                        Key
                                    </option>
                                    <option value="managed_identity" {% if settings.azure_ai_search_authentication_type=='managed_identity' %}selected{% endif %}>
                                        Managed Identity
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3" id="azure_ai_search_key_container" {% if settings.azure_ai_search_authentication_type !='key' %}style="display: none;"{% endif %}>
                                <label for="azure_ai_search_key" class="form-label">Search Key</label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_ai_search_key"
                                        name="azure_ai_search_key"
                                        value="{{ settings.azure_ai_search_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_search_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        
                        <div id="apim_ai_search_settings" {% if not settings.enable_ai_search_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_apim_ai_search_endpoint" class="form-label">
                                    Azure APIM AI Search Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_apim_ai_search_endpoint"
                                    name="azure_apim_ai_search_endpoint"
                                    value="{{ settings.azure_apim_ai_search_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_apim_ai_search_subscription_key" class="form-label">
                                    Azure APIM AI Search Subscription Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_apim_ai_search_subscription_key"
                                        name="azure_apim_ai_search_subscription_key"
                                        value="{{ settings.azure_apim_ai_search_subscription_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_azure_apim_ai_search_subscription_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        
                        <button
                            type="button"
                            class="btn btn-secondary mt-3"
                            style="width: auto;"
                            id="test_azure_ai_search_button"
                        >
                            Test Azure AI Search Connection
                        </button>
                        <div id="test_azure_ai_search_result" class="mt-2"></div>
                    </div>
                </div>

                
                <div class="card p-3 mb-3">
                    <h5>Document Intelligence</h5>
                    <p class="text-muted">
                        Configure Azure Document Intelligence settings.
                    </p>
                    <div class="form-group form-check form-switch mb-3 d-flex align-items-center">
                        <input
                            type="checkbox"
                            class="form-check-input me-2"
                            id="enable_document_intelligence_apim"
                            name="enable_document_intelligence_apim"
                            {% if settings.enable_document_intelligence_apim %}checked{% endif %}
                        >
                        <label class="form-check-label" for="enable_document_intelligence_apim">
                            Use APIM instead of direct Document Intelligence endpoint
                        </label>
                    </div>

                    <div>
                        
                        <div id="non_apim_document_intelligence_settings" {% if settings.enable_document_intelligence_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_document_intelligence_endpoint" class="form-label">
                                    Document Intelligence Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_document_intelligence_endpoint"
                                    name="azure_document_intelligence_endpoint"
                                    value="{{ settings.azure_document_intelligence_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_document_intelligence_authentication_type" class="form-label">
                                    Authentication Type
                                </label>
                                <select class="form-select" id="azure_document_intelligence_authentication_type" name="azure_document_intelligence_authentication_type">
                                    <option value="key" {% if settings.azure_document_intelligence_authentication_type=='key' %}selected{% endif %}>
                                        Key
                                    </option>
                                    <option value="managed_identity" {% if settings.azure_document_intelligence_authentication_type=='managed_identity' %}selected{% endif %}>
                                        Managed Identity
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3" id="azure_document_intelligence_key_container" {% if settings.azure_document_intelligence_authentication_type !='key' %}style="display: none;"{% endif %}>
                                <label for="azure_document_intelligence_key" class="form-label">
                                    Document Intelligence Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_document_intelligence_key"
                                        name="azure_document_intelligence_key"
                                        value="{{ settings.azure_document_intelligence_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_docintel_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        
                        <div id="apim_document_intelligence_settings" {% if not settings.enable_document_intelligence_apim %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="azure_apim_document_intelligence_endpoint" class="form-label">
                                    Azure APIM Document Intelligence Endpoint
                                </label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="azure_apim_document_intelligence_endpoint"
                                    name="azure_apim_document_intelligence_endpoint"
                                    value="{{ settings.azure_apim_document_intelligence_endpoint or '' }}"
                                >
                            </div>
                            <div class="mb-3">
                                <label for="azure_apim_document_intelligence_subscription_key" class="form-label">
                                    Azure APIM Document Intelligence Subscription Key
                                </label>
                                <div class="input-group">
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="azure_apim_document_intelligence_subscription_key"
                                        name="azure_apim_document_intelligence_subscription_key"
                                        value="{{ settings.azure_apim_document_intelligence_subscription_key or '' }}"
                                    >
                                    <button
                                        type="button"
                                        class="btn btn-outline-secondary"
                                        id="toggle_azure_apim_document_intelligence_subscription_key"
                                    >
                                        Show
                                    </button>
                                </div>
                            </div>
                        </div>

                        
                        <button
                            type="button"
                            class="btn btn-secondary mt-3"
                            style="width: auto;"
                            id="test_azure_doc_intelligence_button"
                        >
                            Test Document Intelligence Connection
                        </button>
                        <div id="test_azure_doc_intelligence_result" class="mt-2"></div>
                    </div>
                </div>
            </div>

            
            <div class="tab-pane fade" id="other" role="tabpanel" aria-labelledby="other-tab">
                
                 <p class="text-muted">
                    Miscellaneous or rarely changed settings, such as maximum file size, conversation history limits,
                    etc.
                </p>
                <div class="card p-3 mb-3">
                    <div class="mb-3">
                        <label for="max_file_size_mb" class="form-label">Maximum File Size (MB)</label>
                        <input type="number" class="form-control" id="max_file_size_mb" name="max_file_size_mb"
                            value="{{ settings.max_file_size_mb }}">
                    </div>
                    <div class="mb-3">
                        <label for="conversation_history_limit" class="form-label">
                            Conversation History Limit
                        </label>
                        <input type="number" class="form-control" id="conversation_history_limit"
                            name="conversation_history_limit" value="{{ settings.conversation_history_limit }}">
                    </div>
                    <div class="mb-3">
                        <label for="default_system_prompt" class="form-label">Default System Prompt</label>
                        <textarea class="form-control" id="default_system_prompt" name="default_system_prompt"
                            rows="5">{{ settings.default_system_prompt }}</textarea>
                    </div>
                </div>

                <div class="card mb-3 p-3">
                    <h5>File Processing Logs</h5>
                    <p class="text-muted mb-2">
                        Enable logging of file processing events for debugging and auditing purposes. Logs are stored in the file_processing container in cosmos.
                    </p>

                    
                    <div class="form-group form-check form-switch mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="enable_file_processing_logs"
                            name="enable_file_processing_logs"
                            {% if settings.enable_file_processing_logs %}checked{% endif %}
                        >
                        <label class="form-check-label ms-2" for="enable_file_processing_logs">
                            Enable File Processing Logs
                        </label>
                    </div>
                </div>
            </div>
        </div> 
    </form>
</div>
{% endblock %}
<script>
    // Live preview for banner in admin
    document.addEventListener('DOMContentLoaded', function() {
        const textInput = document.getElementById('classification_banner_text');
        const colorInput = document.getElementById('classification_banner_color');
        const preview = document.getElementById('classification-banner-preview');
        function updatePreview() {
            preview.textContent = textInput.value || 'Banner Preview';
            preview.style.background = colorInput.value;
            preview.style.color = '#fff'; // Always white text for preview
        }
        if (textInput && colorInput && preview) {
            textInput.addEventListener('input', updatePreview);
            colorInput.addEventListener('input', updatePreview);
        }
    });
</script>

{% block scripts %}

<!-- <script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>
 LOCAL VERSION BELOW
-->
 <script src="/static/js/simplemde/simplemde.min.js"></script>
 
<script>
    // Existing SimpleMDE script...
     // We’ll store the SimpleMDE instance globally so we can destroy or read its content
    let simplemde = null;

    // Grab references to the toggle, the editor container, and the preview container
    const toggleLandingPageEditor = document.getElementById("toggleLandingPageEditor");
    const landingPageEditorContainer = document.getElementById("landingPageEditorContainer");
    const landingPageMarkdownPreview = document.getElementById("landingPageMarkdownPreview");

    function showEditor() {
        // Show the text area container
        landingPageEditorContainer.style.display = "block";
        // Hide the preview container
        landingPageMarkdownPreview.style.display = "none";

        // If we haven't already created the editor, do so
        if (!simplemde) {
            simplemde = new SimpleMDE({
                element: document.getElementById("landing_page_text_editor"),
                // Optionally add any SimpleMDE config here:
                // placeholder: "Enter your landing page markdown..."
            });
        }
    }

    function showPreview() {
        // Hide the text area container
        landingPageEditorContainer.style.display = "none";
        // Show the preview container
        landingPageMarkdownPreview.style.display = "block";

        // Render the markdown inside the preview container
        if (simplemde) {
            landingPageMarkdownPreview.innerHTML = simplemde.markdown(simplemde.value());
        } else {
            // If for some reason simplemde is null (e.g., user never toggled on?),
            // just show raw text
            landingPageMarkdownPreview.innerHTML = document.getElementById("landing_page_text_editor").value;
        }
    }

    // Listen for changes on the toggle
    toggleLandingPageEditor.addEventListener("change", () => {
        if (toggleLandingPageEditor.checked) {
            showEditor();
        } else {
            showPreview();
        }
    });

    // On page load, decide which view to show, based on user’s stored setting
    if (toggleLandingPageEditor.checked) {
        showEditor();
    } else {
        showPreview();
    }
</script>

<script>
    // Prepopulate model arrays and classification data from server
    window.gptSelected = JSON.parse('{{ settings.gpt_model.selected|tojson()|safe }}' || '[]');
    window.gptAll      = JSON.parse('{{ settings.gpt_model.all|tojson()|safe }}' || '[]');

    window.embeddingSelected = JSON.parse('{{ settings.embedding_model.selected|tojson()|safe }}' || '[]');
    window.embeddingAll      = JSON.parse('{{ settings.embedding_model.all|tojson()|safe }}' || '[]');

    window.imageSelected = JSON.parse('{{ settings.image_gen_model.selected|tojson()|safe }}' || '[]');
    window.imageAll      = JSON.parse('{{ settings.image_gen_model.all|tojson()|safe }}' || '[]');

    // *** NEW: Classification Data ***
    try {
        let categoriesStr = '{{ settings.document_classification_categories|tojson(indent=None)|safe }}';
        if (!categoriesStr || categoriesStr.trim() === '') {
            categoriesStr = '[]';
        }
        window.classificationCategories = JSON.parse(categoriesStr);
    } catch (e) {
        console.error("Error parsing classification categories:", e);
        window.classificationCategories = [];
    }
    // Ensure it's always an array
    if (!Array.isArray(window.classificationCategories)) {
        window.classificationCategories = [];
    }
    window.enableDocumentClassification = "{{ enable_document_classification }}";

</script>
<script src="{{ url_for('static', filename='js/admin/admin_settings.js') }}"></script>

<!-- Script to update the walkthrough steps based on form changes -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle workspace toggle changes to update requirement status
        const userWorkspaceToggle = document.getElementById('enable_user_workspace');
        const groupWorkspaceToggle = document.getElementById('enable_group_workspaces');
        
        if (userWorkspaceToggle && groupWorkspaceToggle) {
            [userWorkspaceToggle, groupWorkspaceToggle].forEach(toggle => {
                toggle.addEventListener('change', function() {
                    updateWalkthroughRequirements();
                    // Recalculate available steps and refresh navigation
                    const currentStep = getCurrentWalkthroughStep();
                    navigateToWalkthroughStep(currentStep);
                });
            });
        }
        
        // Handle video support toggle in main form
        const videoSupportToggle = document.getElementById('enable_video_file_support');
        if (videoSupportToggle) {
            videoSupportToggle.addEventListener('change', function() {
                updateWalkthroughRequirements();
                
                // Recalculate available steps and refresh navigation
                const currentStep = getCurrentWalkthroughStep();
                navigateToWalkthroughStep(currentStep);
            });
        }
        
        // Handle audio support toggle in main form
        const audioSupportToggle = document.getElementById('enable_audio_file_support');
        if (audioSupportToggle) {
            audioSupportToggle.addEventListener('change', function() {
                updateWalkthroughRequirements();
                
                // Recalculate available steps and refresh navigation
                const currentStep = getCurrentWalkthroughStep();
                navigateToWalkthroughStep(currentStep);
            });
        }
        
        // Handle walkthrough container events
        const walkthroughContainer = document.getElementById('settings-walkthrough-container');
        if (walkthroughContainer) {
            // Close button functionality
            const closeBtn = document.getElementById('close-walkthrough-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', hideWalkthrough);
            }

            // Custom event listener for step changes
            walkthroughContainer.addEventListener('walkthroughStepChanged', function(e) {
                const currentStep = e.detail?.step || 1;
                const totalSteps = document.querySelectorAll('.walkthrough-step').length;
                
                const prevBtn = document.getElementById('walkthrough-prev-btn');
                const nextBtn = document.getElementById('walkthrough-next-btn');
                const finishBtn = document.getElementById('walkthrough-finish-btn');
                
                // Hide/show previous button based on first step
                if (prevBtn) prevBtn.style.display = currentStep === 1 ? 'none' : 'inline-block';
                
                // Show finish button on last step, next button otherwise
                if (nextBtn && finishBtn) {
                    nextBtn.style.display = currentStep === totalSteps ? 'none' : 'inline-block';
                    finishBtn.style.display = currentStep === totalSteps ? 'inline-block' : 'none';
                }
            });
        }
        
        // Initial update
        updateWalkthroughRequirements();
    });
    
    function updateWalkthroughRequirements() {
        const workspaceEnabled = document.getElementById('enable_user_workspace')?.checked || false;
        const groupsEnabled = document.getElementById('enable_group_workspaces')?.checked || false;
        const workspacesEnabled = workspaceEnabled || groupsEnabled;
        
        // Update embedding requirements
        updateRequirementStatus('embedding', workspacesEnabled);
        
        // Update AI Search requirements
        updateRequirementStatus('ai-search', workspacesEnabled);
        
        // Update Document Intelligence requirements
        updateRequirementStatus('doc-intelligence', workspacesEnabled);
        
        // Update Video support requirements
        const videoEnabled = document.getElementById('walkthrough-enable-video')?.checked || 
                            document.getElementById('enable_video_file_support')?.checked || false;
        updateRequirementStatus('video-support', workspacesEnabled && videoEnabled);
        
        // Update Audio support requirements
        const audioEnabled = document.getElementById('walkthrough-enable-audio')?.checked || 
                            document.getElementById('enable_audio_file_support')?.checked || false;
        updateRequirementStatus('audio-support', workspacesEnabled && audioEnabled);
        
        // If we're in the walkthrough, update completion status for current step
        const currentStepElem = document.querySelector('.walkthrough-step:not([style*=\'display: none\'])');
        if (currentStepElem) {
            const currentStep = parseInt(currentStepElem.id?.split('-')[2]) || 1;
            if (typeof updateStepCompletionStatus === 'function') {
                updateStepCompletionStatus(currentStep);
            }
        }
    }
    
    function updateRequirementStatus(section, isRequired, isComplete = false) {
        // Update requirement alert
        const requirementAlert = document.getElementById(`${section}-requirement-alert`);
        if (requirementAlert) {
            if (isRequired && isComplete) {
                requirementAlert.className = 'alert alert-success';
                requirementAlert.innerHTML = '<strong>Complete:</strong> Configuration finished for this section.';
            } else if (isRequired) {
                requirementAlert.className = 'alert alert-danger';
                requirementAlert.innerHTML = '<strong>Required:</strong> This configuration is required for workspace functionality.';
            } else {
                requirementAlert.className = 'alert alert-info';
                requirementAlert.innerHTML = '<strong>Optional:</strong> This configuration is optional.';
            }
        }
        
        // Update badges
        const badges = document.querySelectorAll(`[id$="${section}-badge"], [id*="${section}-"][id$="badge"]`);
        badges.forEach(badge => {
            if (isRequired && isComplete) {
                badge.className = 'badge bg-success';
                badge.textContent = 'Complete';
            } else if (isRequired) {
                badge.className = 'badge bg-danger';
                badge.textContent = 'Required';
            } else {
                badge.className = 'badge bg-secondary';
                badge.textContent = 'Optional';
            }
        });
    }

    // Function to hide the walkthrough
    function hideWalkthrough() {
        const container = document.getElementById('settings-walkthrough-container');
        if (container) {
            container.style.display = 'none';
        }
    }
    
    /**
     * Finishes the walkthrough and saves the form
     */
    function finishSetupAndSave() {
        // Hide the walkthrough
        hideWalkthrough();
        
        // Submit the form
        document.getElementById('admin-settings-form').submit();
    }
</script>
{% endblock %}
