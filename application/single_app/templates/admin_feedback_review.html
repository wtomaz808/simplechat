<!-- templates/admin_feedback_review.html -->

{% extends "base.html" %}
{% block title %}
  Feedback Review - {{ app_settings.app_title }}
{% endblock %}

{% block head %}
  <style>
    /* Force fixed layout for consistency */
    #feedback-table {
      table-layout: fixed;
      width: 100%;
    }

    /* Adjust column widths - align with safety violations where applicable */
    #feedback-table th:nth-child(1), /* Prompt */
    #feedback-table td:nth-child(1) {
        width: 20%; /* Adjusted for consistency */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    #feedback-table th:nth-child(2), /* AI Response */
    #feedback-table td:nth-child(2) {
        width: 20%; /* Adjusted for consistency */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    #feedback-table th:nth-child(3), /* Feedback Type */
    #feedback-table td:nth-child(3) {
        width: 100px;
    }
     #feedback-table th:nth-child(4), /* Reason */
    #feedback-table td:nth-child(4) {
        width: 20%; /* Adjusted for consistency */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    #feedback-table th:nth-child(5), /* Acknowledged */
    #feedback-table td:nth-child(5) {
        width: 120px;
    }
    #feedback-table th:nth-child(6), /* Action Taken */
    #feedback-table td:nth-child(6) {
        width: 15%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
     /* Edit & Retest button columns - match safety violations 'Edit' width */
     #feedback-table th:nth-child(7),
     #feedback-table td:nth-child(7),
     #feedback-table th:nth-child(8),
     #feedback-table td:nth-child(8) {
         width: 70px; /* Consistent width for action buttons */
         text-align: center;
     }

     /* Ensure table cells align middle */
    #feedback-table td {
        vertical-align: middle;
    }

    /* Style for loading state */
    .table-loading-row td {
        text-align: center;
        padding: 2rem;
        color: #6c757d; /* text-muted */
    }

  </style>
{% endblock %}

{% block content %}

<div class="container">
  <h2>Feedback Review</h2>
  <p class="text-muted">
    Review and analyze user feedback. Use the filters below to narrow down feedback by type or acknowledgment status.
  </p>
  <hr />

  <!-- FILTERS ROW - Updated structure and classes -->
  <div class="row mb-3 align-items-end">
    <div class="col-md-3">
      <label for="filterFeedbackType" class="form-label mb-1">Filter by Feedback Type:</label> 
      <select id="filterFeedbackType" class="form-select form-select-sm">
        <option value="">(All Types)</option>
        <option value="Positive">Positive</option>
        <option value="Negative">Negative</option>
        <option value="Neutral">Neutral</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="filterAcknowledged" class="form-label mb-1">Filter by Acknowledged:</label> 
      <select id="filterAcknowledged" class="form-select form-select-sm">
        <option value="">(All Statuses)</option>
        <option value="true">Acknowledged</option>
        <option value="false">Not Acknowledged</option>
      </select>
    </div>
    <div class="col-md-6 text-md-end mt-2 mt-md-0"> 
         <button id="applyFiltersBtn" class="btn btn-primary btn-sm">Apply Filters</button>
         <button id="clearFiltersBtn" class="btn btn-secondary btn-sm ms-1">Clear Filters</button>
    </div>
  </div>

  <!-- Feedback Table -->
  <div class="table-responsive">
      <table id="feedback-table" class="table table-striped">
        <thead>
          <tr>
            <th title="User's input that led to the AI response">Prompt</th>
            <th title="The response generated by the AI">AI Response</th>
            <th title="User's classification of the response">Feedback Type</th>
            <th title="User's reason for the feedback">Reason</th>
            <th title="Whether an admin has acknowledged this feedback">Acknowledged</th>
            <th title="Action taken by admin based on feedback">Action Taken</th>
            <th>Edit</th>
            <th>Retest</th>
          </tr>
        </thead>
        <tbody>
          <!-- Populated via JS -->
          <tr class="table-loading-row"> 
              <td colspan="8">
                  <div class="spinner-border spinner-border-sm me-2" role="status"> 
                      <span class="visually-hidden">Loading...</span>
                  </div>
                  Loading feedback...
              </td>
          </tr>
        </tbody>
      </table>
  </div>

  <!-- Pagination Controls Area -->
  <div class="d-flex align-items-center gap-3 mb-3">
    <!-- Page Size Section -->
    <div>
      <label for="page-size-select" class="visually-hidden">Items per page:</label>
      <select id="page-size-select" class="form-select form-select-sm d-inline-block" style="width:auto;">
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option> 
      </select>
      <span class="ms-1 small text-muted">items per page</span>
    </div>

    <!-- Pagination Controls -->
    <div id="pagination-container" class="d-flex gap-1 ms-auto">
        
    </div>
  </div>

</div>

<!-- ===== Modal for Editing a Single Feedback Entry ===== -->

<div class="modal fade" id="editFeedbackModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Feedback Entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <div id="editModalLoading" class="text-center" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="editModalContent">
            <div class="mb-3">
            <label class="form-label fw-bold">Timestamp:</label>
            <p id="editTimestamp" class="form-control-plaintext"></p>
            </div>

            <div class="mb-3">
            <label class="form-label fw-bold">User ID:</label>
            <p id="editUserId" class="form-control-plaintext"></p>
            </div>

            <div class="mb-3">
            <label class="form-label fw-bold">Prompt:</label>
            <p id="editPrompt" class="form-control-plaintext" style="white-space: pre-wrap;"></p>
            </div>

            <div class="mb-3">
            <label class="form-label fw-bold">AI Response:</label>
            <p id="editAiResponse" class="form-control-plaintext" style="white-space: pre-wrap;"></p>
            </div>

            <div class="mb-3">
            <label class="form-label fw-bold">Feedback Type:</label>
            <p id="editFeedbackType" class="form-control-plaintext"></p>
            </div>

            <div class="mb-3">
            <label class="form-label fw-bold">Reason:</label>
            <p id="editReason" class="form-control-plaintext" style="white-space: pre-wrap;"></p>
            </div>

            <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="editAcknowledged" />
            <label class="form-check-label" for="editAcknowledged">Acknowledged</label>
            </div>

            <div class="mb-3">
            <label class="form-label fw-bold">Analysis Notes:</label>
            <textarea class="form-control" id="editAnalysisNotes" rows="2"></textarea>
            </div>

            <div class="mb-3">
            <label class="form-label fw-bold">Response to User:</label>
            <textarea class="form-control" id="editResponseToUser" rows="2"></textarea>
            </div>

            <div class="mb-3">
            <label class="form-label fw-bold">Action Taken:</label>
            <input type="text" class="form-control" id="editActionTaken" />
            </div>

            <input type="hidden" id="editFeedbackId" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" id="saveFeedbackChangesBtn" class="btn btn-primary">
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>


<!-- Modal to view retest results -->
<div class="modal fade" id="retestModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Retest Result</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="retest-body">
        <!-- Retest AI response goes here -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- State Variables ---
let currentPage = 1;
let pageSize = 10;

// --- DOM Element References ---
const tableBody = document.querySelector("#feedback-table tbody");
const paginationContainer = document.getElementById("pagination-container");
const pageSizeSelect = document.getElementById("page-size-select");
const filterTypeSelect = document.getElementById("filterFeedbackType");
const filterAckSelect = document.getElementById("filterAcknowledged");
const applyFiltersBtn = document.getElementById("applyFiltersBtn"); // Added
const clearFiltersBtn = document.getElementById("clearFiltersBtn"); // Added

// --- Utility Functions ---
function escapeHtml(unsafe) {
    if (unsafe === null || typeof unsafe === 'undefined') return '';
    return unsafe.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
  }

// --- Core Data Fetching and Rendering ---

function fetchFeedbackData(page = currentPage) {
  currentPage = page; // Update current page state
  pageSize = parseInt(pageSizeSelect.value, 10);
  const filterType = filterTypeSelect.value;
  const filterAck = filterAckSelect.value;

  // Show loading state in table
  tableBody.innerHTML = `<tr class="table-loading-row"><td colspan="8"><div class="spinner-border spinner-border-sm me-2" role="status"><span class="visually-hidden">Loading...</span></div> Loading feedback...</td></tr>`;
  paginationContainer.innerHTML = ""; // Clear old pagination

  // Construct query parameters
  const params = new URLSearchParams({
    page: currentPage,
    page_size: pageSize,
  });
  if (filterType) params.append('type', filterType);
  if (filterAck) params.append('ack', filterAck);

  // Assume backend endpoint `/feedback/review` handles pagination/filtering
  fetch(`/feedback/review?${params.toString()}`)
    .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
    .then(data => {
      populateTable(data.feedback);
      renderPaginationControls(data.page, data.page_size, data.total_count);
    })
    .catch(err => {
      console.error("Error loading feedback:", err);
      tableBody.innerHTML = `<tr class="table-loading-row"><td colspan="8" class="text-danger">Error loading feedback: ${escapeHtml(err.error || err.message || 'Unknown error')}</td></tr>`;
      renderPaginationControls(1, pageSize, 0); // Show empty pagination
    });
}

function populateTable(feedbackItems) {
  tableBody.innerHTML = ""; // Clear loading/previous content

  if (!feedbackItems || feedbackItems.length === 0) {
    tableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-muted">No feedback found matching the criteria.</td></tr>';
    return;
  }

  feedbackItems.forEach(item => {
    const ackText = item.adminReview?.acknowledged ? "Yes" : "No";
    const promptText = escapeHtml(item.prompt || "");
    const aiResponseText = escapeHtml(item.aiResponse || "");
    const reasonText = escapeHtml(item.reason || "");
    const actionTakenText = escapeHtml(item.adminReview?.actionTaken || "");
    const feedbackTypeText = escapeHtml(item.feedbackType || "");

    const row = document.createElement("tr");
    // Using textContent for safety where HTML isn't needed
    row.innerHTML = `
      <td title="${promptText}"></td>
      <td title="${aiResponseText}"></td>
      <td></td>
      <td title="${reasonText}"></td>
      <td></td>
      <td></td>
      <td>
        <button class="btn btn-sm btn-primary edit-feedback-btn" data-id="${item.id}" title="Edit Review Details">
          <i class="bi bi-pencil-fill"></i>
        </button>
      </td>
      <td>
        <button class="btn btn-sm btn-secondary retest-btn" data-id="${item.id}"
          data-prompt="${escapeHtml(item.prompt || "")}" title="Retest Original Prompt">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </td>
    `;
    // Set text content safely for columns potentially containing user input/html
    row.cells[0].textContent = item.prompt || "";
    row.cells[1].textContent = item.aiResponse || "";
    row.cells[2].textContent = feedbackTypeText;
    row.cells[3].textContent = reasonText;
    row.cells[4].textContent = ackText;
    row.cells[5].textContent = actionTakenText;

    tableBody.appendChild(row);
  });
}

// --- Pagination Control Rendering (Keep As Is) ---
function renderPaginationControls(page, pageSize, totalCount) {
    paginationContainer.innerHTML = ""; // clear old
    const totalPages = Math.ceil(totalCount / pageSize);

    if (totalPages <= 1) return; // Don't show pagination if only one page

    const ul = document.createElement('ul');
    ul.classList.add('pagination', 'pagination-sm', 'mb-0');

    // --- Create Page Link Helper ---
    const createPageLink = (pageNum, text, isDisabled = false, isActive = false) => {
        const li = document.createElement('li');
        li.classList.add('page-item');
        if (isDisabled) li.classList.add('disabled');
        if (isActive) {
             li.classList.add('active');
             li.setAttribute('aria-current', 'page');
        }

        const a = document.createElement('a');
        a.classList.add('page-link');
        a.href = '#';
        a.innerHTML = text; // Allow HTML for arrows like «

        if (!isDisabled && !isActive) {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                fetchFeedbackData(pageNum); // Call fetch function on click
            });
        }
        li.appendChild(a);
        return li;
    };

    // Previous Button
    ul.appendChild(createPageLink(page - 1, '«', page <= 1));

    // Page Number Logic (Ellipsis) - Same as safety violations
    const maxPagesToShow = 5;
    let startPage = 1;
    let endPage = totalPages;

    if (totalPages > maxPagesToShow) {
        let maxPagesBeforeCurrent = Math.floor(maxPagesToShow / 2);
        let maxPagesAfterCurrent = Math.ceil(maxPagesToShow / 2) - 1;

        if (page <= maxPagesBeforeCurrent) {
            startPage = 1; endPage = maxPagesToShow;
        } else if (page + maxPagesAfterCurrent >= totalPages) {
            startPage = totalPages - maxPagesToShow + 1; endPage = totalPages;
        } else {
            startPage = page - maxPagesBeforeCurrent; endPage = page + maxPagesAfterCurrent;
        }
    }

     // Add first page and ellipsis if needed
     if (startPage > 1) {
         ul.appendChild(createPageLink(1, '1'));
         if (startPage > 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.classList.add('page-item', 'disabled');
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            ul.appendChild(ellipsisLi);
         }
     }

    // Page links
    for (let p = startPage; p <= endPage; p++) {
        ul.appendChild(createPageLink(p, p, false, p === page));
    }

    // Add last page and ellipsis if needed
     if (endPage < totalPages) {
         if (endPage < totalPages - 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.classList.add('page-item', 'disabled');
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            ul.appendChild(ellipsisLi);
         }
        ul.appendChild(createPageLink(totalPages, totalPages));
     }

    // Next Button
    ul.appendChild(createPageLink(page + 1, '»', page >= totalPages));

    paginationContainer.appendChild(ul);
}


// --- Modal and Actions Logic (Keep As Is) ---

function openEditModal(feedbackId) {
  const modalEl = new bootstrap.Modal(document.getElementById("editFeedbackModal"));
  const modalBodyContent = document.getElementById("editModalContent");
  const loadingIndicator = document.getElementById("editModalLoading");

  modalBodyContent.style.display = 'none';
  loadingIndicator.style.display = 'block';
  modalEl.show();

  fetch(`/feedback/review/${feedbackId}`)
    .then(r => {
        if (!r.ok) { return r.json().then(err => Promise.reject(err)); }
        return r.json();
    })
    .then(item => {
        document.getElementById("editTimestamp").textContent = item.timestamp ? new Date(item.timestamp).toLocaleString() : "N/A";
        document.getElementById("editUserId").textContent = item.userId || "N/A";
        document.getElementById("editPrompt").textContent = item.prompt || "";
        document.getElementById("editAiResponse").textContent = item.aiResponse || "";
        document.getElementById("editFeedbackType").textContent = item.feedbackType || "";
        document.getElementById("editReason").textContent = item.reason || "";
        const acknowledged = item.adminReview?.acknowledged ? true : false;
        document.getElementById("editAcknowledged").checked = acknowledged;
        document.getElementById("editAnalysisNotes").value = item.adminReview?.analysisNotes || "";
        document.getElementById("editResponseToUser").value = item.adminReview?.responseToUser || "";
        document.getElementById("editActionTaken").value = item.adminReview?.actionTaken || "";
        document.getElementById("editFeedbackId").value = item.id;
        loadingIndicator.style.display = 'none';
        modalBodyContent.style.display = 'block';
    })
    .catch(err => {
        console.error("Error fetching feedback details:", err);
        modalBodyContent.innerHTML = `<div class="alert alert-danger">Failed to load feedback details: ${escapeHtml(err.error || err.message || 'Unknown error')}</div>`;
         loadingIndicator.style.display = 'none';
        modalBodyContent.style.display = 'block';
    });
}

function saveChanges() {
  const feedbackId = document.getElementById("editFeedbackId").value;
  const saveButton = document.getElementById("saveFeedbackChangesBtn");

  const payload = {
    acknowledged: document.getElementById("editAcknowledged").checked,
    analysisNotes: document.getElementById("editAnalysisNotes").value.trim(),
    responseToUser: document.getElementById("editResponseToUser").value.trim(),
    actionTaken: document.getElementById("editActionTaken").value.trim()
  };

  saveButton.disabled = true;
  saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

  fetch(`/feedback/review/${feedbackId}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  })
    .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
    .then(data => {
      // Assuming success if status is ok, or check data.success if backend sends it
      const modalEl = bootstrap.Modal.getInstance(document.getElementById("editFeedbackModal"));
      modalEl.hide();
      fetchFeedbackData(currentPage); // Refresh the current page view
    })
    .catch(err => {
        console.error("Update error:", err);
        alert("Failed to save changes: " + (err.message || err.error || "Unknown error"));
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.textContent = "Save Changes";
    });
}

function retestPrompt(feedbackId, prompt) {
  if (!prompt) {
      alert("Cannot retest: Prompt is empty.");
      return;
  }
  const retestButton = document.querySelector(`.retest-btn[data-id='${feedbackId}']`);
  const originalButtonHtml = retestButton ? retestButton.innerHTML : '<i class="bi bi-arrow-clockwise"></i>';
  if(retestButton) {
      retestButton.disabled = true;
      retestButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
  }

  const modalEl = new bootstrap.Modal(document.getElementById("retestModal"));
  const retestBody = document.getElementById("retest-body");
  retestBody.innerHTML = `<div class="text-center p-3"><div class="spinner-border" role="status"><span class="visually-hidden">Retesting...</span></div></div>`;
  modalEl.show();

  fetch(`/feedback/retest/${feedbackId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt: prompt }),
  })
    .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
    .then(data => {
      retestBody.innerHTML = data.retestResponse ? `<p style="white-space: pre-wrap;">${escapeHtml(data.retestResponse)}</p>` : `<div class="alert alert-warning">${escapeHtml(data.error || 'No response returned.')}</div>`;
    })
    .catch(err => {
        console.error("Retest error:", err);
        retestBody.innerHTML = `<div class="alert alert-danger">Error during retest: ${escapeHtml(err.error || err.message || "Unknown error")}</div>`;
    })
    .finally(() => {
         if(retestButton) {
             retestButton.disabled = false;
             retestButton.innerHTML = originalButtonHtml;
         }
    });
}

// --- Event Listeners Setup ---
document.addEventListener("DOMContentLoaded", function() {
  // 1) Initial data load
  fetchFeedbackData(1);

  // 2) Page size change
  pageSizeSelect.addEventListener("change", () => {
    fetchFeedbackData(1); // Go back to page 1 when size changes
  });

  // 3) Filter Buttons (NEW)
  applyFiltersBtn.addEventListener('click', () => {
      fetchFeedbackData(1); // Go back to page 1 when applying filters
  });

  clearFiltersBtn.addEventListener('click', () => {
      filterTypeSelect.value = ''; // Reset dropdowns
      filterAckSelect.value = '';
      fetchFeedbackData(1); // Fetch with cleared filters, back to page 1
  });

  // 4) Save button inside edit modal
  document.getElementById("saveFeedbackChangesBtn").addEventListener("click", saveChanges);

  // 5) Event delegation for buttons inside the table body
  tableBody.addEventListener("click", function(e) {
    const targetButton = e.target.closest("button");
    if (!targetButton) return;

    if (targetButton.classList.contains("edit-feedback-btn")) {
      const feedbackId = targetButton.getAttribute("data-id");
      if (feedbackId) openEditModal(feedbackId);
    }
    else if (targetButton.classList.contains("retest-btn")) {
      const feedbackId = targetButton.getAttribute("data-id");
      const prompt = targetButton.getAttribute("data-prompt"); // Fetch prompt from data attribute
      // Ensure prompt is correctly fetched before calling
      if (feedbackId && typeof prompt === 'string') { // Check if prompt is a string (even empty)
            retestPrompt(feedbackId, prompt);
      } else {
            console.warn("Could not retest: Prompt data attribute missing or invalid on button.", targetButton);
            alert("Could not retest: prompt data is missing.");
      }
    }
  });

   // 6) Remove automatic filtering on select change (OLD logic)
   // filterTypeSelect.addEventListener("change", () => { fetchFeedbackData(1); });
   // filterAckSelect.addEventListener("change", () => { fetchFeedbackData(1); });
});

</script>
{% endblock %}